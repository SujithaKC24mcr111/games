<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circuit Construction Game | STEM Learning</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        header {
            background: linear-gradient(90deg, #3498db, #2ecc71);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
        }
        
        h1 {
            font-size: 2.2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .game-area {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .game-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .canvas-container {
            flex: 2;
            min-width: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        #circuitCanvas {
            background: #fff;
            border-radius: 8px;
            display: block;
            margin: 0 auto;
            border: 2px solid #3498db;
            cursor: pointer;
        }
        
        .components {
            flex: 1;
            min-width: 250px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        .component-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .component-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: grab;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            user-select: none;
        }
        
        .component-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
        }
        
        .component-icon {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
        }
        
        .slider-container {
            margin: 15px 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="range"] {
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 5px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .value-display {
            text-align: center;
            font-weight: 600;
            color: #e74c3c;
            margin-top: 5px;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        
        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        #simulateBtn {
            background: #2ecc71;
            color: white;
        }
        
        #simulateBtn:hover {
            background: #27ae60;
        }
        
        #resetBtn {
            background: #e74c3c;
            color: white;
        }
        
        #resetBtn:hover {
            background: #c0392b;
        }
        
        #presetBtn {
            background: #3498db;
            color: white;
        }
        
        #presetBtn:hover {
            background: #2980b9;
        }
        
        .circuit-info {
            display: flex;
            justify-content: space-around;
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1c40f;
        }
        
        .concept-explanation {
            background: #e8f4fc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
        }
        
        .concept-explanation h3 {
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .language-selector {
            text-align: center;
            margin: 15px 0;
        }
        
        select {
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #3498db;
            background: white;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .wire-controls {
            background: #f1f8fe;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .wire-controls.active {
            display: block;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: #2c3e50;
            color: white;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .component-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <div>
                    <h1>Circuit Construction Game</h1>
                    <div class="subtitle">Learn electronics through interactive circuit building</div>
                </div>
            </div>
        </header>
        
        <div class="game-area">
            <div class="game-container">
                <div class="canvas-container">
                    <h2>Circuit Workspace</h2>
                    <canvas id="circuitCanvas" width="600" height="400"></canvas>
                    <div class="circuit-info">
                        <div class="info-item">
                            <div>Voltage</div>
                            <div class="info-value" id="voltageValue">0 V</div>
                        </div>
                        <div class="info-item">
                            <div>Current</div>
                            <div class="info-value" id="currentValue">0 A</div>
                        </div>
                        <div class="info-item">
                            <div>Resistance</div>
                            <div class="info-value" id="resistanceValue">0 Œ©</div>
                        </div>
                    </div>
                </div>
                
                <div class="components">
                    <h2>Components</h2>
                    <p>Drag components to the workspace or click to connect wires</p>
                    
                    <div class="component-list">
                        <div class="component-item" data-type="battery">
                            <div class="component-icon">üîã</div>
                            <div>Battery</div>
                        </div>
                        <div class="component-item" data-type="resistor">
                            <div class="component-icon">üìè</div>
                            <div>Resistor</div>
                        </div>
                        <div class="component-item" data-type="bulb">
                            <div class="component-icon">üí°</div>
                            <div>Light Bulb</div>
                        </div>
                        <div class="component-item" data-type="switch">
                            <div class="component-icon">üîò</div>
                            <div>Switch</div>
                        </div>
                        <div class="component-item" data-type="wire">
                            <div class="component-icon">üîå</div>
                            <div>Wire</div>
                        </div>
                        <div class="component-item" data-type="led">
                            <div class="component-icon">üíà</div>
                            <div>LED</div>
                        </div>
                        <div class="component-item" data-type="voltmeter">
                            <div class="component-icon">üìè</div>
                            <div>Voltmeter</div>
                        </div>
                    </div>
                    
                    <div class="wire-controls" id="wireControls">
                        <h3>Wire Properties</h3>
                        <div class="control-group">
                            <label for="wireLengthSlider">Wire Length (cm)</label>
                            <input type="range" id="wireLengthSlider" min="5" max="100" value="20">
                            <div class="value-display" id="wireLengthValue">20 cm</div>
                        </div>
                        
                        <div class="control-group">
                            <label for="wireMaterial">Wire Material</label>
                            <select id="wireMaterial">
                                <option value="0.0000000168">Copper (Low Resistance)</option>
                                <option value="0.0000001000">Iron (Medium Resistance)</option>
                                <option value="0.0000010000">Nichrome (High Resistance)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label for="voltageSlider">Battery Voltage (V)</label>
                        <input type="range" id="voltageSlider" min="1" max="12" value="9">
                        <div class="value-display" id="voltageSliderValue">9 V</div>
                    </div>
                    
                    <div class="control-group">
                        <label for="resistanceSlider">Resistor Value (Œ©)</label>
                        <input type="range" id="resistanceSlider" min="10" max="1000" value="100">
                        <div class="value-display" id="resistanceSliderValue">100 Œ©</div>
                    </div>
                    
                    <div class="buttons">
                        <button id="simulateBtn">Simulate Circuit</button>
                        <button id="resetBtn">Reset Circuit</button>
                        <button id="presetBtn">Load Series Circuit</button>
                    </div>
                </div>
            </div>
            
            <div class="concept-explanation">
                <h3>Physics Concepts: Electric Circuits & Wire Resistance</h3>
                <p>An electric circuit is a path through which electrons flow from a voltage source. Key concepts include:</p>
                <ul>
                    <li><strong>Voltage (V)</strong>: The electrical potential difference that causes electrons to flow</li>
                    <li><strong>Current (I)</strong>: The rate of flow of electric charge, measured in Amperes (A)</li>
                    <li><strong>Resistance (R)</strong>: Opposition to the flow of current, measured in Ohms (Œ©)</li>
                    <li><strong>Ohm's Law</strong>: V = I √ó R (Voltage = Current √ó Resistance)</li>
                    <li><strong>Wire Resistance</strong>: R = œÅL/A, where œÅ is resistivity, L is length, and A is cross-sectional area</li>
                    <li><strong>Series Circuits</strong>: Components connected one after another</li>
                    <li><strong>Parallel Circuits</strong>: Components connected across common points</li>
                </ul>
                <p>Build circuits, adjust wire properties, and use the voltmeter to explore these concepts!</p>
            </div>
            
            <div class="language-selector">
                <select id="languageSelect">
                    <option value="en">English</option>
                    <option value="hi">Hindi</option>
                    <option value="or">Odia</option>
                    <option value="te">Telugu</option>
                </select>
            </div>
        </div>
        
        <footer>
            <p>Gamified STEM Learning Platform | Developed for Government of Odisha</p>
            <p>This game works both online and offline, making it suitable for rural areas with limited connectivity</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const canvas = document.getElementById('circuitCanvas');
        const ctx = canvas.getContext('2d');
        const voltageSlider = document.getElementById('voltageSlider');
        const resistanceSlider = document.getElementById('resistanceSlider');
        const wireLengthSlider = document.getElementById('wireLengthSlider');
        const wireMaterialSelect = document.getElementById('wireMaterial');
        const voltageSliderValue = document.getElementById('voltageSliderValue');
        const resistanceSliderValue = document.getElementById('resistanceSliderValue');
        const wireLengthValue = document.getElementById('wireLengthValue');
        const simulateBtn = document.getElementById('simulateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const presetBtn = document.getElementById('presetBtn');
        const voltageValue = document.getElementById('voltageValue');
        const currentValue = document.getElementById('currentValue');
        const resistanceValue = document.getElementById('resistanceValue');
        const componentItems = document.querySelectorAll('.component-item');
        const wireControls = document.getElementById('wireControls');
        
        // Game variables
        let components = [];
        let selectedComponent = null;
        let isSimulating = false;
        let batteryVoltage = 9;
        let resistorValue = 100;
        let wireLength = 20; // in cm
        let wireResistivity = 0.0000000168; // Copper in Œ©¬∑m
        let circuitCurrent = 0;
        let totalResistance = 0;
        let wireStart = null;
        let animationFrameId = null;
        
        // Component class
        class CircuitComponent {
            constructor(type, x, y, width = 60, height = 40) {
                this.type = type;
                this.x = Math.round(x / 20) * 20; // Snap to grid
                this.y = Math.round(y / 20) * 20;
                this.width = width;
                this.height = height;
                this.connected = false;
                this.value = type === 'battery' ? batteryVoltage : 
                            type === 'resistor' ? resistorValue : 0;
                this.color = this.getColor();
                this.lit = false;
                this.wireLength = type === 'wire' ? wireLength : 0;
                this.resistivity = type === 'wire' ? wireResistivity : 0;
                this.endpoints = this.getEndpoints();
                this.connections = [];
                this.electronOffset = 0;
            }
            
            getColor() {
                switch(this.type) {
                    case 'battery': return '#f1c40f';
                    case 'resistor': return '#8e44ad';
                    case 'bulb': return isSimulating && this.lit ? '#f1c40f' : '#7f8c8d';
                    case 'switch': return '#3498db';
                    case 'wire': return this.connected && isSimulating ? '#f1c40f' : '#2c3e50';
                    case 'led': return isSimulating && this.lit ? '#00ff00' : '#7f8c8d';
                    case 'voltmeter': return '#e67e22';
                    default: return '#34495e';
                }
            }
            
            getEndpoints() {
                if (this.type === 'wire') {
                    return [
                        { x: this.x, y: this.y },
                        { x: this.x + this.width, y: this.y + this.height }
                    ];
                }
                return [
                    { x: this.x, y: this.y + this.height/2 },
                    { x: this.x + this.width, y: this.y + this.height/2 }
                ];
            }
            
            draw() {
                ctx.fillStyle = this.getColor();
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 2;
                
                switch(this.type) {
                    case 'battery':
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                        ctx.beginPath();
                        ctx.moveTo(this.x + this.width/2, this.y - 5);
                        ctx.lineTo(this.x + this.width/2, this.y);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(this.x + this.width/2, this.y + this.height);
                        ctx.lineTo(this.x + this.width/2, this.y + this.height + 5);
                        ctx.stroke();
                        ctx.fillStyle = '#fff';
                        ctx.font = '12px Arial';
                        ctx.fillText(`${this.value}V`, this.x + 15, this.y + 25);
                        break;
                        
                    case 'resistor':
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y + this.height/2);
                        ctx.lineTo(this.x - 10, this.y + this.height/2);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(this.x + this.width, this.y + this.height/2);
                        ctx.lineTo(this.x + this.width + 10, this.y + this.height/2);
                        ctx.stroke();
                        ctx.fillStyle = '#fff';
                        ctx.font = '12px Arial';
                        ctx.fillText(`${this.value}Œ©`, this.x + 15, this.y + 25);
                        break;
                        
                    case 'bulb':
                        ctx.beginPath();
                        ctx.arc(this.x + this.width/2, this.y + this.height/2, this.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(this.x + this.width/2, this.y + this.height/2 + this.width/2);
                        ctx.lineTo(this.x + this.width/2, this.y + this.height/2 + this.width/2 + 10);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(this.x + this.width/2 - 5, this.y + this.height/2 + this.width/2 + 5);
                        ctx.lineTo(this.x + this.width/2 + 5, this.y + this.height/2 + this.width/2 + 5);
                        ctx.stroke();
                        break;
                        
                    case 'switch':
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                        if (this.connected && isSimulating) {
                            ctx.strokeStyle = '#2ecc71';
                            ctx.beginPath();
                            ctx.moveTo(this.x + this.width/2, this.y);
                            ctx.lineTo(this.x + this.width/2, this.y + this.height);
                            ctx.stroke();
                        } else {
                            ctx.strokeStyle = '#e74c3c';
                            ctx.beginPath();
                            ctx.moveTo(this.x + this.width/2, this.y);
                            ctx.lineTo(this.x, this.y + this.height);
                            ctx.stroke();
                        }
                        break;
                        
                    case 'wire':
                        ctx.strokeStyle = this.connected && isSimulating ? '#f1c40f' : '#2c3e50';
                        ctx.lineWidth = 4;
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y);
                        ctx.lineTo(this.x + this.width, this.y + this.height);
                        ctx.stroke();
                        ctx.fillStyle = '#333';
                        ctx.font = '10px Arial';
                        ctx.fillText(`${this.wireLength}cm`, this.x + this.width/2 - 15, this.y - 5);
                        if (isSimulating && this.connected) {
                            this.drawElectrons();
                        }
                        break;
                        
                    case 'led':
                        ctx.beginPath();
                        ctx.moveTo(this.x, this.y);
                        ctx.lineTo(this.x + this.width/2, this.y + this.height);
                        ctx.lineTo(this.x + this.width, this.y);
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(this.x + this.width/2, this.y + this.height);
                        ctx.lineTo(this.x + this.width/2, this.y + this.height + 10);
                        ctx.stroke();
                        break;
                        
                    case 'voltmeter':
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                        ctx.fillStyle = '#fff';
                        ctx.font = '12px Arial';
                        ctx.fillText('Voltmeter', this.x + 5, this.y + 25);
                        if (this.connections.length === 2) {
                            const v = this.measureVoltage();
                            ctx.fillText(`${v.toFixed(2)}V`, this.x + 5, this.y + 35);
                        }
                        break;
                }
                
                // Draw connection points
                ctx.fillStyle = '#ff0000';
                this.endpoints.forEach(ep => {
                    ctx.beginPath();
                    ctx.arc(ep.x, ep.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                });
            }
            
            drawElectrons() {
                ctx.fillStyle = '#ff0000';
                for (let i = 0; i < 3; i++) {
                    const t = (this.electronOffset + i * 0.3) % 1;
                    const px = this.x + t * this.width;
                    const py = this.y + t * this.height;
                    ctx.beginPath();
                    ctx.arc(px, py, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            containsPoint(x, y) {
                if (this.type === 'wire') {
                    // Check proximity to line
                    const dx = this.x + this.width - this.x;
                    const dy = this.y + this.height - this.y;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const dist = Math.abs((dy * x - dx * y + this.x * this.height - this.y * this.width) / length);
                    return dist < 5;
                }
                return x >= this.x && x <= this.x + this.width && 
                       y >= this.y && y <= this.y + this.height;
            }
            
            getNearestEndpoint(x, y) {
                let minDist = Infinity;
                let closest = 0;
                this.endpoints.forEach((ep, i) => {
                    const dist = Math.sqrt((x - ep.x) ** 2 + (y - ep.y) ** 2);
                    if (dist < minDist) {
                        minDist = dist;
                        closest = i;
                    }
                });
                return { index: closest, distance: minDist };
            }
            
            connectTo(otherComponent, endpointIndex, otherEndpointIndex) {
                this.connections.push({ component: otherComponent, endpoint: endpointIndex, otherEndpoint: otherEndpointIndex });
                otherComponent.connections.push({ component: this, endpoint: otherEndpointIndex, otherEndpoint: endpointIndex });
            }
            
            calculateResistance() {
                if (this.type === 'wire') {
                    const crossSectionArea = 0.0000005; // 0.5 mm¬≤ in m¬≤
                    return (this.resistivity * (this.wireLength / 100)) / crossSectionArea;
                }
                return this.type === 'resistor' || this.type === 'bulb' || this.type === 'led' ? this.value : 0;
            }
            
            measureVoltage() {
                if (this.type !== 'voltmeter' || this.connections.length !== 2) return 0;
                // Simplified: Assume voltage drop across connected components
                const [comp1, comp2] = this.connections.map(c => c.component);
                if (comp1.type === 'battery') return comp1.value;
                return Math.abs(comp1.value - comp2.value);
            }
        }
        
        // Initialize the game
        function init() {
            drawWorkspace();
            
            voltageSlider.addEventListener('input', function() {
                const voltage = parseInt(this.value);
                voltageSliderValue.textContent = `${voltage} V`;
                batteryVoltage = voltage;
                components.forEach(comp => {
                    if (comp.type === 'battery') comp.value = voltage;
                });
                if (isSimulating) simulateCircuit();
                drawWorkspace();
            });
            
            resistanceSlider.addEventListener('input', function() {
                const resistance = parseInt(this.value);
                resistanceSliderValue.textContent = `${resistance} Œ©`;
                resistorValue = resistance;
                components.forEach(comp => {
                    if (comp.type === 'resistor' || comp.type === 'bulb' || comp.type === 'led') {
                        comp.value = resistance;
                    }
                });
                if (isSimulating) simulateCircuit();
                drawWorkspace();
            });
            
            wireLengthSlider.addEventListener('input', function() {
                const length = parseInt(this.value);
                wireLengthValue.textContent = `${length} cm`;
                wireLength = length;
                components.forEach(comp => {
                    if (comp.type === 'wire') comp.wireLength = length;
                });
                if (isSimulating) simulateCircuit();
                drawWorkspace();
            });
            
            wireMaterialSelect.addEventListener('change', function() {
                wireResistivity = parseFloat(this.value);
                components.forEach(comp => {
                    if (comp.type === 'wire') comp.resistivity = wireResistivity;
                });
                if (isSimulating) simulateCircuit();
                drawWorkspace();
            });
            
            simulateBtn.addEventListener('click', simulateCircuit);
            resetBtn.addEventListener('click', resetCircuit);
            presetBtn.addEventListener('click', loadPresetCircuit);
            
            componentItems.forEach(item => {
                item.addEventListener('mousedown', (e) => {
                    const type = item.getAttribute('data-type');
                    selectedComponent = type;
                    wireControls.classList.toggle('active', type === 'wire');
                });
            });
            
            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check for switch toggle
                for (let comp of components) {
                    if (comp.type === 'switch' && comp.containsPoint(x, y)) {
                        comp.connected = !comp.connected;
                        if (isSimulating) simulateCircuit();
                        drawWorkspace();
                        return;
                    }
                }
                
                // Check for existing component
                for (let i = components.length - 1; i >= 0; i--) {
                    if (components[i].containsPoint(x, y)) {
                        selectedComponent = components[i];
                        components.splice(i, 1);
                        components.push(selectedComponent);
                        wireControls.classList.toggle('active', selectedComponent.type === 'wire');
                        if (selectedComponent.type === 'wire') {
                            wireLengthSlider.value = selectedComponent.wireLength;
                            wireLengthValue.textContent = `${selectedComponent.wireLength} cm`;
                            for (let j = 0; j < wireMaterialSelect.options.length; j++) {
                                if (parseFloat(wireMaterialSelect.options[j].value) === selectedComponent.resistivity) {
                                    wireMaterialSelect.selectedIndex = j;
                                    break;
                                }
                            }
                        }
                        drawWorkspace();
                        return;
                    }
                }
                
                // Handle wire creation
                if (selectedComponent === 'wire') {
                    const snapX = Math.round(x / 20) * 20;
                    const snapY = Math.round(y / 20) * 20;
                    let connected = false;
                    let startComp = null, startEp = 0;
                    
                    for (let comp of components) {
                        if (comp.type === 'wire') continue;
                        const ep = comp.getNearestEndpoint(snapX, snapY);
                        if (ep.distance < 10) {
                            wireStart = { x: ep.index === 0 ? comp.x : comp.x + comp.width, y: comp.y + comp.height/2, comp, ep: ep.index };
                            connected = true;
                            break;
                        }
                    }
                    
                    if (!connected) {
                        wireStart = { x: snapX, y: snapY };
                    }
                    return;
                }
                
                // Add new component
                if (selectedComponent && typeof selectedComponent === 'string') {
                    const newComponent = new CircuitComponent(selectedComponent, x - 30, y - 20);
                    components.push(newComponent);
                    selectedComponent = null;
                    wireControls.classList.remove('active');
                    drawWorkspace();
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (selectedComponent && typeof selectedComponent === 'object') {
                    const rect = canvas.getBoundingClientRect();
                    selectedComponent.x = Math.round((e.clientX - rect.left - 30) / 20) * 20;
                    selectedComponent.y = Math.round((e.clientY - rect.top - 20) / 20) * 20;
                    selectedComponent.endpoints = selectedComponent.getEndpoints();
                    drawWorkspace();
                }
            });
            
            canvas.addEventListener('mouseup', (e) => {
                if (selectedComponent && typeof selectedComponent === 'object') {
                    selectedComponent = null;
                } else if (wireStart) {
                    const rect = canvas.getBoundingClientRect();
                    const x = Math.round((e.clientX - rect.left) / 20) * 20;
                    const y = Math.round((e.clientY - rect.top) / 20) * 20;
                    
                    let endComp = null, endEp = 0;
                    for (let comp of components) {
                        if (comp.type === 'wire') continue;
                        const ep = comp.getNearestEndpoint(x, y);
                        if (ep.distance < 10) {
                            x = ep.index === 0 ? comp.x : comp.x + comp.width;
                            y = comp.y + comp.height/2;
                            endComp = comp;
                            endEp = ep.index;
                            break;
                        }
                    }
                    
                    const newWire = new CircuitComponent('wire', wireStart.x, wireStart.y, x - wireStart.x, y - wireStart.y);
                    components.push(newWire);
                    if (wireStart.comp) {
                        newWire.connectTo(wireStart.comp, 0, wireStart.ep);
                    }
                    if (endComp) {
                        newWire.connectTo(endComp, 1, endEp);
                    }
                    wireStart = null;
                    drawWorkspace();
                }
            });
        }
        
        // Draw the workspace
        function drawWorkspace() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background grid
            ctx.strokeStyle = '#ecf0f1';
            ctx.lineWidth = 1;
            for (let x = 0; x <= canvas.width; x += 20) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= canvas.height; y += 20) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Draw components
            components.forEach(component => component.draw());
        }
        
        // Animate electrons
        function animateElectrons() {
            if (!isSimulating) {
                cancelAnimationFrame(animationFrameId);
                return;
            }
            components.forEach(comp => {
                if (comp.type === 'wire' && comp.connected) {
                    comp.electronOffset = (comp.electronOffset + circuitCurrent * 0.05) % 1;
                }
            });
            drawWorkspace();
            animationFrameId = requestAnimationFrame(animateElectrons);
        }
        
        // Simulate the circuit
        function simulateCircuit() {
            isSimulating = true;
            let hasBattery = components.some(c => c.type === 'battery');
            let hasLoad = components.some(c => c.type === 'resistor' || c.type === 'bulb' || c.type === 'led');
            let hasCompletePath = components.some(c => c.type === 'wire');
            
            // Check for closed loop (simplified)
            let connectedComponents = new Set();
            components.forEach(comp => {
                comp.connections.forEach(conn => {
                    connectedComponents.add(comp);
                    connectedComponents.add(conn.component);
                });
            });
            
            if (hasBattery && hasLoad && hasCompletePath && connectedComponents.size >= 3) {
                totalResistance = 0;
                components.forEach(comp => {
                    if (comp.type === 'switch' && !comp.connected) return;
                    totalResistance += comp.calculateResistance();
                });
                
                circuitCurrent = batteryVoltage / totalResistance;
                
                components.forEach(comp => {
                    if (comp.type === 'switch' && !comp.connected) return;
                    comp.connected = true;
                    if (comp.type === 'bulb' || comp.type === 'led') {
                        comp.lit = circuitCurrent > 0.05;
                    }
                });
                
                voltageValue.textContent = `${batteryVoltage} V`;
                resistanceValue.textContent = `${totalResistance.toFixed(2)} Œ©`;
                currentValue.textContent = `${circuitCurrent.toFixed(2)} A`;
                
                animateElectrons();
            } else {
                alert("Incomplete circuit! Ensure battery, load, and wires form a closed loop.");
                resetCircuit();
            }
        }
        
        // Reset the circuit
        function resetCircuit() {
            isSimulating = false;
            components.forEach(comp => {
                comp.connected = false;
                comp.lit = false;
                comp.electronOffset = 0;
            });
            voltageValue.textContent = "0 V";
            resistanceValue.textContent = "0 Œ©";
            currentValue.textContent = "0 A";
            wireControls.classList.remove('active');
            cancelAnimationFrame(animationFrameId);
            drawWorkspace();
        }
        
        // Load preset series circuit
        function loadPresetCircuit() {
            resetCircuit();
            components = [
                new CircuitComponent('battery', 100, 100),
                new CircuitComponent('resistor', 200, 100),
                new CircuitComponent('bulb', 300, 100),
                new CircuitComponent('wire', 100, 150, 200, 0),
                new CircuitComponent('wire', 300, 150, -200, 0)
            ];
            components[3].connectTo(components[0], 0, 1);
            components[3].connectTo(components[1], 1, 0);
            components[4].connectTo(components[1], 0, 1);
            components[4].connectTo(components[2], 1, 0);
            components[2].connectTo(components[0], 1, 0);
            drawWorkspace();
        }
        
        // Initialize the game
        window.addEventListener('load', init);
        
        // Language selector
        document.getElementById('languageSelect').addEventListener('change', function() {
            alert(`Language changed to ${this.options[this.selectedIndex].text}.`);
        });
    </script>
</body>
</html>

